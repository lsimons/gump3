#!/bin/bash
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
#
# A (supposedly ) friendly commandline interface to the common gump tasks
#
#############################################################################
# Documentation
#############################################################################

# Documentation for the different commands.
function usage
{
  case $1 in
    run)
      echo "
      Run Gumpy.

      Usage:
        $0 run [gump.py-args ...]

      See http://wiki.apache.org/gump/GumpCommandLineOptions for more
      information about the options Gumpy accepts. The one mandatory
      argument is the "project expression" detailing what to run. You
      will usually want "all" here.
"
        ;;
    debug)
      echo "
      Run Gumpy in debug mode.
      
      Usage:
        $0 debug [gump.py-args ...]
    
      This is the same as executing the 'run' command with a '--debug'
      parameter.
"
        ;;
    test)
      echo "
      Run Gumpy its unit tests.

      Usage:
        $0 test
"
        ;;
    integration-test)
      echo "
      Run Gumpy its integration tests.

      Usage:
        $0 integration-test [gump.py-args ...]
"
		;;
    site)
      echo "
      Use Apache Forrest to build the documentation.

      Usage:
        $0 site
"
      ;;
    site-publish)
      echo "
      Use svn and ssh to publish the site.

      Usage:
        $0 site-publish
"
      ;;
    validate)
      echo "
      Run the DTD validation tools on the metadata.

      Usage:
        $0 validate
"
      ;;
    experimental-tests)
      echo "
      Run the experimental new unit tests using testrunner.py.

      Usage:
        $0 experimental-tests
"
      ;;
    *)
      echo "
     _____
    |   __|_ Apache_ ___ 
    |  |  | | |     | . |
    |_____|___|_|_|_|  _|
                    |_|
     
      Usage:
        $0 command [opts ...]
     
      Available commands are:
     
        run -- run Gumpy
        test -- run Gumpy its unit tests
        validate -- validate the metadata
        site -- use Apache Forrest to build the documentation
        site-publish -- use SVN and SSH to publish the site to the website
    help -- print this information
     
      Run
     
        $0 help [command]
     
      for more information about a particular command.
"
      ;;
  esac
}

#############################################################################
# Utility methods
#############################################################################

# Print an error message and then exit.
function error
{
  echo "$1"
  exit 1
}

# Load the environment variables script if it exists
function load_env
{
  local host=`hostname -s`
  local envfile="`pwd`/cron/local-env-$host.sh"
  if [[ -f $envfile ]]; then
    . $envfile
  fi
}

# Print a friendly error message if some dependency is missing.
#
# Arguments:
#   - name of the command
#   - url to download the package that provides it
function check_env
{
  local cmd=`bin/PrintPath $1`;
  if [[ -z "$cmd" ]]; then
     error "Cannot find $1. Please retrieve it from 

     $2
     
and install it."
  fi
}

# Print a friendly error message if an environment variable is not set.
#
# Arguments:
#   - name of the variable
#   - description of what the variable should be set to
function check_env_var
{
  local host=`hostname -s`
  local envfile="`pwd`/cron/local-env-$host.sh"

  local dereferenced=${!1}
  if [[ -z "$dereferenced" ]]; then
    error "The variable $1 has not been set. It should be set to
$2.
You can either set this before invoking gump, or set it in a file
named
  $envfile.sh
"
  fi
}

# Print a friendly error message i a python library is not available.
#
# Arguments:
#   - the library to import
#   - url to download location of the library
function check_env_pylib
{
  cat > pycmd.tmp.py <<ENDCOMMAND
try:
  import $1
except:
  print "error"
ENDCOMMAND
  local cmd=`python pycmd.tmp.py`
  result=`$cmd`
  rm -f pycmd.tmp.py

  if [[ ! -z "$result" ]]; then
    error "Required python library $1 is not available.
Please download it from

  $2

and install it."
  fi
}

# Figure out which action to execute.
function delegate
{
  local called_as=$0
  local command=$1
  shift

  if [[ -z "$command" ]]; then
    error "Illegal command '$command'"
  fi

  # delegate to the command handling functions
  case $command in

    run)
      run $@
      ;;
    debug)
      run --debug $@
      ;;
    test)
      test $@
      ;;
    integration-test)
      integration_test $@
      ;;
    site)
      site $@
      ;;
    site-publish)
      site_publish $@
      ;;
    validate)
      validate $0
      ;;
    help | usage | --help | -help | -H | -h)
      usage $@
      ;;
    experimental-tests)
      experimental_tests $@
      ;;
    '')
      usage $@
      ;;
    *)
      error "Unknown command '$command'"
      ;;
  esac
}

#############################################################################
# Actions
#############################################################################

# Run gumpy.
function run
{
  check_env "python" "http://www.python.org/"
  check_env "pkill" "http://sourceforge.net/projects/proctools"

  check_env_var "GUMP_HOME" "the location of the gump checkout"
  check_env_var "JAVA_HOME" "the location of the java jdk"
  
  check_env_pylib "rdflib" "http://rdflib.net/"
  check_env_pylib "MySQLdb" "http://sourceforge.net/projects/mysql-python"

  cd cron
  ./gump.sh $@
  cd ..
}

# Run gumpy unit tests
function test
{
  check_env "python" "http://www.python.org/"
  check_env_var "GUMP_HOME" "the location of the gump checkout"

  local oldpythonpath=$PYTHONPATH
  if [[ -z $oldpythonpath ]]; then
    export PYTHONPATH=`pwd`/python:`pwd`
  else
    export PYTHONPATH=`pwd`/python:`pwd`:$PYTHONPATH
  fi

  # Run the tests
  cd python
  python ../bin/testrunner.py -d ../python/gump/test $@
  cd ..
  
  # Clean up (NB: tests ought to do this themselves...)
  rm -Rf python/test python/bogus python/x.svg python/gump/test/cache \
      python/gump/test/temp \
      python/gump/test/test python/gump/test/work
}

# Run gumpy integration tests
function integration_test
{
  echo "

This is currently not working! For some strange reason,
gumpy thinks we have no projects defined :(

"

  local doupdate=$GUMP_NO_SCM_UPDATE
  export GUMP_NO_SCM_UPDATE=true
  run --workspace `pwd`/test/fixture/workspace.xml $@ #all
  export GUMP_NO_SCM_UPDATE=$doupdate
}

# Use Apache Forrest to build the documentation.
function site
{
  check_env "forrest" "http://forrest.apache.org/mirrors.cgi"

  forrest
}

# Use svn and ssh to publish the site.
function site_publish
{
  check_env "svn" "http://subversion.tigris.org/"
  check_env "ssh" "http://www.openssh.org/"

  error 'This functionality is not yet tested!'

  cp -Rf build/site/* ../site/
  cd ../site/
  find . -type d -or -type -f -not -path '*/.svn*' -exec svn add \{\} \;
  svn commit -m "Publishing site..."
  ssh minotaur.apache.org svn up /www/gump.apache.org
  cd ../trunk/
}

# Check out or update the gump metadata.
function get_metadata
{
  check_env "cvs" "http://www.cvshome.org/"

  local cvsroot=$1
  if [[ -z "$cvsroot" ]]; then
    cvsroot=":pserver:anoncvs@cvs.apache.org:/home/cvspublic"
  fi

  if [[ -d "metadata/CVS" ]]; then
    cvs -d $cvsroot up -Pd metadata
  else
    # This is not dumb. Cannot check out into an existing checkout,
    # and cannot remove the metadata either because 'svn up' will
    # get confused that way
    cvs -d $cvsroot co -d gump.cvs gump
    mv gump.cvs/* metadata/
    rm -Rf gump.cvs
  fi
}

# Run the DTD validation tools on the metadata.
function validate
{
  check_env "xmllint" "http://xmlsoft.org/"
  check_env "xsltproc" "http://xmlsoft.org/"

  cd metadata
  ./validate
  cd ..
}

# Run the experimental new unit tests.
function experimental_tests
{
  check_env "python" "http://www.python.org/"

  local oldpythonpath=$PYTHONPATH
  if [[ -z $oldpythonpath ]]; then
    export PYTHONPATH=`pwd`/src/py:`pwd`
  else
    export PYTHONPATH=`pwd`/src/py:`pwd`:$PYTHONPATH
  fi

  local dir=$1
  if [[ -z "$dir" ]]; then
    dir='src/py'
  else
    shift
  fi

  find $dir -name *.pyc | xargs rm -Rf  # get rid of compiled files
  python bin/testrunner.py -d $dir $@   # run the tests

  export PYTHONPATH=$oldpythonpath
}

#############################################################################
# Run the script...
#############################################################################

# Load any environment variables
load_env

# Figure out the action to take then run the appropriate function
delegate $@

#############################################################################
# And some mess below...
#############################################################################

#option=$@
#previous_argument=
#for option
#do
   # get argument to options with arguments
#  if test -n "$previous_argument"; then
#    eval "$previous_argument=\$option"
#    previous_argument=
#    continue
#  fi
#done
